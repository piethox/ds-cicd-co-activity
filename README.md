# David Vulnerability Scan CI/CD

## Steps
1. Create new repository, then clone to your local. 
2. Run “npm init” inside the new repo folder
New files will be created (package.json and package-lock.json)
- package.json : contains descriptive and functional metadata about a project, such as a name, version and dependencies
- package-lock.json : automatically generated by npm when a package is installed, including its sub-dependencies and versions.
3. Create .gitignore and ensure to put “node_modules/” and “.serverless” are inside
4. Push new files to github repo
5. Install serverless using “npm install serverless”
6. Install serverless offline using “npm install serverless-offline –save-dev”
7. push all changes git add 
8. Create index.js file with following codes
  ```js
  module.exports.handler = async (event) => {
    return {
      statusCode: 200,
      body: JSON.stringify(
        {
          message: "Your function executed successfully!",
          access_key: process.env.ACCESS_KEY
        },
        null,
        2
      ),
    };
  };
  ```
9. Create serverless.yml with below codes
```js
service: david-cicd-act
frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  region: ap-southeast-1
  deploymentBucket:
    name: cohort2.serverless.deploys

functions:
  api:
    handler: index.handler
    events:
      - httpApi:
          path: /
          method: get
    environment:
      ACCESS_KEY: ${ssm:ds-parameter}

plugins:
  - serverless-offline
```
_Use particular bucket "cohort2.serverless.deploys" to point serverless state file_

10. Create store parameter named "ds-parameter" in AWS -> Systems Manager 
11. run locally for testing with command: serverless offline start

12. create index.test.js file with below contents :
```js
const { handler } = require("./index");
describe("handler", () => {
  test("should return a valid response", async () => {
    const event = {}; // You can customize the event object if needed
    const result = await handler(event);

    expect(result).toEqual({
      statusCode: 200,
      body: JSON.stringify(
        {
          message: "Your function executed successfully!",
        },
        null,
        2
      ),
    });
  });
});
```

13. Add AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY on github “Secrets and variables”
14. Create github action workflow for CICD inside .github/workflows/main.yml file with following flows :
- run when push action on any branches
- install-dependencies : github actions & npm install
- unit-testing : github actions, npm install & npm test
- package-scan : github actions, npm install, npm test & **npm audit**
- deploy-serverless : github actions, use node.js, npm ci, serverless deploy with AWS Secret Key attributes
15. push to github repo and check on github actions tab
